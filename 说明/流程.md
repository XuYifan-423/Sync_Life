# 人体姿态监测与数据归档核心流程（含实时计算 + 存储）

## 一、流程总览

前端实时采集→数据预处理→姿态 / 角度计算→风险等级判定→触发条件校验→知识库归档，全程按 “用户 id 分组” 贯穿，确保数据归属唯一、可追溯。

## 二、详细步骤（按执行顺序）

### 步骤 1：初始化与数据准备（系统启动 / 用户登录时）

1. 后端加载前后端统一枚举（`State`姿态枚举、`AgeGroup`年龄分组枚举、`PostureRiskLevel`风险等级枚举）及多姿态角度标准表（含各年龄组 + 各姿态的腰椎 / 躯干角度范围）；
2. 用户登录后，后端从数据库调取该用户基础信息（`id`/`age`/`age_group`/`weight`/`height`/`ills`），以`id`为核心键建立临时缓存，关联后续计算结果；
3. 初始化 “方差最小稳定角度计算器”（躯干倾斜角实例），配置默认参数（滑动窗口大小 N=15，方差阈值 σ²=1.5°²；老年群体自动调整为 N=20，σ²=2.5°²）。

### 步骤 2：前端数据实时采集与传输

1. 前端通过传感器 / 骨骼检测算法采集用户姿态相关数据（如骨骼关键点坐标），实时传输至后端（需携带用户`id`，确保数据归属）；
2. 传输数据需包含：用户`id`、当前时间戳（精确到毫秒）、原始姿态数据（如关键点坐标）。

### 步骤 3：后端数据预处理

1. 数据校验：过滤用户`id`不存在、时间戳异常、原始数据缺失的无效请求；
2. 异常值过滤：基于人体生理极限，剔除超范围角度的原始数据（躯干倾斜角≤-10° 或≥40° 直接丢弃）；
3. 姿态状态初步识别：通过算法解析原始数据，初步判定用户当前姿态状态（`State`：LIE/STAND/SIT/WALK/RUN）。

### 步骤 4：方差最小稳定角度计算（核心步骤）

1. 姿态锁定：若当前姿态与上一轮姿态一致，将预处理后的有效角度数据（躯干倾斜角）传入对应计算器；若姿态切换，清空对应计算器的滑动窗口、均值、方差等参数，重新初始化计算；
2. 滑动窗口维护：计算器按预设窗口大小 N 累积数据，当数据量≥N 时，新增 1 组数据则移除最早 1 组数据（保持窗口长度固定）；
3. 迭代方差计算：采用 “迭代式方差公式”（O (1) 时间复杂度），实时更新窗口内角度的均值和方差，提取 “方差最小的稳定角度”（腰椎稳定角、躯干稳定角分别计算）；
4. 结果输出：仅当窗口数据量≥N 时，输出稳定角度；数据量不足时，暂不进行后续判定。

### 步骤 5：姿态风险等级判定

1. 基准匹配：根据用户`age_group`（年龄分组）和当前`State`（姿态），从角度标准表中匹配对应的腰椎 / 躯干角度正常范围；

2. 偏差计算：计算稳定角度与对应正常范围的偏差值（偏差值 =| 稳定角度 - 正常范围中点值 |）；

3. 风险分级：
   
   - 稳定角度在正常范围内→`PostureRiskLevel=NORMAL`（正常）；
   - 稳定角度超出范围，但偏差≤10°（老年群体无腰椎 / 脊柱疾病且无不适时，放宽至≤12°）→`PostureRiskLevel=MILD_RISK`（轻微偏差 / 低风险）；
   - 稳定角度超出范围，且偏差＞10°（老年群体＞12°）→`PostureRiskLevel=SEVERE_RISK`（严重偏差 / 高风险）。

### 步骤 6：记录触发条件校验

仅当满足以下任一条件时，触发知识库存储操作（避免无效重复存储）：

1. 姿态状态切换：当前`State`与上一条存储记录的`State`不一致（如从 SIT 切换为 WALK）；
2. 风险等级切换：当前`PostureRiskLevel`与上一条存储记录的`PostureRiskLevel`不一致（如从 NORMAL 切换为 MILD_RISK）；
3. 特殊情况：用户首次传输有效数据（无历史存储记录），直接触发存储。

### 步骤 7：知识库数据归档（按用户 id 分组存储）

1. 数据补全：整理存储所需字段，包括用户`id`、`start_time`（当前时间戳）、`state`（当前姿态）、`lumbar_stable_angle`（腰椎稳定角）、`trunk_stable_angle`（躯干稳定角）、`posture_risk_level`（风险等级）、`age_group`（年龄分组）、`ills`（既往疾病）；
2. 历史记录更新：若存在上一条未结束的记录（`end_time`为 null），先补全其`end_time`为当前`start_time`，并计算`duration`（持续时长 = end_time - start_time）；
3. 新记录存储：以用户`id`为分组键，将补全后的字段存储到该`id`对应的专属数据区块，`end_time`初始化为 null，`duration`初始化为 null。

### 步骤 8：流程循环与异常处理

1. 循环执行：后端持续接收前端数据，重复步骤 3-7，实现实时监测与归档；
2. 数据中断处理：若前端数据中断超过 30 秒（可配置），自动补全当前未结束记录的`end_time`（中断时间戳）和`duration`；
3. 姿态异常跳变处理：若连续 3 组数据的姿态状态不一致（如 SIT→WALK→SIT），判定为异常跳变，丢弃中间跳变记录，保留前后稳定姿态的记录。

## 三、流程关键节点说明

1. 效率保障：稳定角度计算采用 O (1) 迭代算法，单组数据处理耗时＜1ms，支持高频数据流；
2. 数据一致性：所有枚举类型、角度范围、计算参数前后端严格统一，避免解析偏差；
3. 老年群体适配：在步骤 3 异常值过滤、步骤 5 风险分级中，均结合`ills`字段调整规则，贴合老年人生理特征；
4. 可追溯性：按用户`id`分组存储，每条记录包含完整的时间区间（`start_time`/`end_time`/`duration`），支持后续姿态趋势分析与健康建议生成。
